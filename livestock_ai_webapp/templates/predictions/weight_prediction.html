{% extends 'base.html' %}

{% block title %}Weight Estimation - Livestock AI{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="display-5 fw-bold text-primary">
                    <i class="bi bi-speedometer2"></i> Weight Estimation
                </h1>
                <p class="lead text-muted">
                    Upload an image of your livestock to get an accurate weight prediction
                </p>
            </div>

            <!-- Upload Form -->
            <div class="card">
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data" id="weightForm">
                        {% csrf_token %}
                        <div class="upload-area" id="uploadArea">
                            <i class="bi bi-cloud-upload display-4 text-muted mb-3"></i>
                            <h5>Upload Livestock Image</h5>
                            <p class="text-muted mb-3">
                                Drag and drop your image here, or click to browse
                            </p>
                            <input type="file" name="image" id="imageInput" accept="image/*" required class="d-none">
                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageInput').click()">
                                <i class="bi bi-folder2-open"></i> Choose File
                            </button>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="bi bi-cpu"></i> Analyze Weight
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results -->
            <div id="resultsContainer" style="display: none;">
                <!-- Results will be displayed here via JavaScript -->
            </div>
            
            {% if result %}
            <div class="result-card mt-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="mb-3">
                            <i class="bi bi-check-circle"></i> Weight Prediction Results
                        </h3>
                        {% if result.status == 'success' %}
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="mb-2">Predicted Weight</h4>
                                <h2 class="text-warning fw-bold">{{ result.predicted_weight }} kg</h2>
                            </div>
                            <div class="col-md-6">
                                <h4 class="mb-2">Model Type</h4>
                                <p class="mb-0">{{ result.model_type }}</p>
                            </div>
                        </div>
                        {% else %}
                        <div class="alert alert-danger">
                            <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
                            <p class="mb-0">{{ result.error }}</p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="bg-white bg-opacity-25 rounded p-3">
                            <i class="bi bi-speedometer2 display-4"></i>
                            <p class="mb-0 mt-2">Weight Analysis</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Error Display -->
            {% if error %}
            <div class="alert alert-danger mt-4">
                <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
                <p class="mb-0">{{ error }}</p>
            </div>
            {% endif %}

            <!-- Debug Info -->
            {% if debug_info %}
            <div class="alert alert-info mt-4">
                <h5><i class="bi bi-bug"></i> Debug Info</h5>
                <p class="mb-0">{{ debug_info }}</p>
            </div>
            {% endif %}

            <!-- Form Debug -->
            <div class="card mt-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-bug"></i> Form Debug (This will help us see what's happening)
                    </h5>
                </div>
                <div class="card-body">
                    <div id="formDebug">
                        <p>Form ready. Upload an image and click "Analyze Weight" to see debug info.</p>
                    </div>
                </div>
            </div>

            <!-- Tips -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-lightbulb"></i> Tips for Best Results
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-check-circle text-success"></i> Do:</h6>
                            <ul class="list-unstyled">
                                <li>‚Ä¢ Use side-view images</li>
                                <li>‚Ä¢ Ensure good lighting</li>
                                <li>‚Ä¢ Include the full animal</li>
                                <li>‚Ä¢ Use high-resolution images</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-x-circle text-danger"></i> Don't:</h6>
                            <ul class="list-unstyled">
                                <li>‚Ä¢ Use blurry images</li>
                                <li>‚Ä¢ Include multiple animals</li>
                                <li>‚Ä¢ Use extreme angles</li>
                                <li>‚Ä¢ Include humans in frame</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');
    const form = document.getElementById('weightForm');
    const submitBtn = document.getElementById('submitBtn');

    // File input change handler
    imageInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Update upload area display
            uploadArea.innerHTML = `
                <i class="bi bi-image display-4 text-success mb-3"></i>
                <h5>Selected: ${file.name}</h5>
                <p class="text-muted mb-3">Ready to analyze</p>
                <button type="button" class="btn btn-outline-secondary" id="changeFileBtn">
                    <i class="bi bi-arrow-clockwise"></i> Change File
                </button>
            `;
            
            // Add event listener to the new button
            document.getElementById('changeFileBtn').addEventListener('click', function() {
                document.getElementById('imageInput').click();
            });
        }
    });

    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // PREVENT DEFAULT FORM SUBMISSION
        console.log('Form submission started');
        
        // Update debug info
        document.getElementById('formDebug').innerHTML = '<p class="text-info">üîÑ Form submission started...</p>';
        
        if (!imageInput.files[0]) {
            alert('Please select an image file first.');
            document.getElementById('formDebug').innerHTML = '<p class="text-danger">‚ùå No image file selected</p>';
            return;
        }
        
        console.log('Image file selected:', imageInput.files[0].name);
        document.getElementById('formDebug').innerHTML = `
            <p class="text-success">‚úÖ Image file selected: ${imageInput.files[0].name}</p>
            <p class="text-info">üìÅ File size: ${(imageInput.files[0].size / 1024).toFixed(1)} KB</p>
            <p class="text-info">üîÑ Submitting form via AJAX...</p>
        `;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Analyzing...';
        submitBtn.disabled = true;
        
        // Submit form via AJAX
        const formData = new FormData();
        formData.append('image', imageInput.files[0]);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        console.log('FormData contents:');
        for (let [key, value] of formData.entries()) {
            console.log(key, value);
        }
        
        fetch('/weight/', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Response received:', response.status);
            document.getElementById('formDebug').innerHTML += '<p class="text-info">üì° Response received from server</p>';
            return response.text();
        })
        .then(html => {
            console.log('Response HTML received');
            document.getElementById('formDebug').innerHTML += '<p class="text-success">‚úÖ Server response received</p>';
            
            // Parse the response and extract debug info
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Check for debug info
            const debugInfo = doc.querySelector('.alert-info');
            if (debugInfo) {
                document.getElementById('formDebug').innerHTML += `<p class="text-info">üîç ${debugInfo.textContent.trim()}</p>`;
            }
            
            // Check for results and display them
            const resultCard = doc.querySelector('.result-card');
            if (resultCard) {
                document.getElementById('formDebug').innerHTML += '<p class="text-success">üéâ Results found in response!</p>';
                
                // Extract weight from result
                const weightElement = resultCard.querySelector('.text-warning');
                if (weightElement) {
                    document.getElementById('formDebug').innerHTML += `<p class="text-success">‚öñÔ∏è Predicted Weight: ${weightElement.textContent}</p>`;
                    
                    // Display the results in the main results section
                    const resultsContainer = document.querySelector('.result-card') || document.querySelector('#resultsContainer');
                    if (resultsContainer) {
                        resultsContainer.innerHTML = resultCard.innerHTML;
                        resultsContainer.style.display = 'block';
                    } else {
                        // Create results container if it doesn't exist
                        const newResultsContainer = document.createElement('div');
                        newResultsContainer.className = 'result-card mt-4';
                        newResultsContainer.innerHTML = resultCard.innerHTML;
                        newResultsContainer.style.display = 'block';
                        
                        // Insert after the form
                        const form = document.getElementById('weightForm');
                        form.parentNode.insertBefore(newResultsContainer, form.nextSibling);
                    }
                }
            }
            
            // Check for errors
            const errorAlert = doc.querySelector('.alert-danger');
            if (errorAlert) {
                document.getElementById('formDebug').innerHTML += `<p class="text-danger">‚ùå Error: ${errorAlert.textContent.trim()}</p>`;
            }
            
            // Reset button
            submitBtn.innerHTML = '<i class="bi bi-cpu"></i> Analyze Weight';
            submitBtn.disabled = false;
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('formDebug').innerHTML += `<p class="text-danger">‚ùå AJAX Error: ${error}</p>`;
            
            // Reset button
            submitBtn.innerHTML = '<i class="bi bi-cpu"></i> Analyze Weight';
            submitBtn.disabled = false;
        });
        
        console.log('Form submitted via AJAX, waiting for response...');
    });
});
</script>
{% endblock %}
